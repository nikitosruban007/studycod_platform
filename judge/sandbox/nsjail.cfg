# StudyCod Judge - base nsjail sandbox profile (production)
#
# This file is intentionally "generic": the actual command (compiler/runtime) is provided by the
# judge worker via nsjail CLI after `--`.
#
# Dynamic per-submission limits (time/memory/output) are passed as CLI overrides by the worker.
#
# SECURITY GOALS:
# - no network
# - read-only root filesystem
# - no /proc
# - seccomp whitelist
# - cgroups enabled (memory/cpu/pids)
#
# REQUIRED HOST SETUP (see README):
# - /sandbox/rootfs: minimal chroot with python3, java, g++, libc, etc.
# - /sys/fs/cgroup mounted and writable for nsjail (run as root or with proper capabilities)

name: "studycod-judge"
mode: EXECUTE

# Root filesystem isolation.
chroot: "/sandbox/rootfs"
cwd: "/work"

# Use cgroups for hard caps (per worker). Keep this parent dedicated to the judge service.
cgroup_mem_parent: "studycod"
cgroup_pids_parent: "studycod"
cgroup_cpu_parent: "studycod"

# Default caps (overridden per submit by CLI flags).
cgroup_mem_max: 268435456          # 256MB
cgroup_mem_memsw_max: 268435456   # 256MB
cgroup_pids_max: 64               # allow JVM threads
cgroup_cpu_ms_per_sec: 1000       # 1 CPU core

# No network.
disable_clone_newnet: true

# Namespaces: keep defaults aligned with typical nsjail deployments.
disable_clone_newuser: false
disable_clone_newns: false
disable_clone_newpid: true
disable_clone_newipc: false
disable_clone_newuts: false
disable_clone_newcgroup: false
disable_clone_newtime: false

# Read-only root, writable tmp.
mount {
  src: "/sandbox/rootfs"
  dst: "/"
  is_bind: true
  rw: false
}
mount {
  src: "tmpfs"
  dst: "/tmp"
  fstype: "tmpfs"
  rw: true
  options: "size=64M,mode=1777"
}

# No /proc.
mount_proc: false

# Drop privileges inside the jail (requires user namespaces enabled).
uidmap: "0 1000 1"
gidmap: "0 1000 1"

# Hardening: seccomp allowlist.
# NOTE: This list is a compromise across C++/Python/Java. Tightening it further is possible,
# but must be validated against the runtime syscalls for each language.
seccomp_string: "~read,write,open,openat,close,mmap,munmap,mprotect,brk,rt_sigaction,rt_sigprocmask,ioctl,access,pipe,pipe2,select,poll,ppoll,readv,writev,clone,execve,exit,exit_group,arch_prctl,set_tid_address,set_robust_list,futex,getpid,getppid,getuid,getgid,geteuid,getegid,gettid,getdents64,getcwd,chdir,stat,newfstatat,fstat,lseek,uname,readlink,getrandom,prlimit64,getrusage,times,clock_gettime,clock_getres,gettimeofday,time,nanosleep,restart_syscall,sysinfo,rt_sigtimedwait,sched_getaffinity,sched_yield,setrlimit"

# Conservative defaults (worker overrides time/output; still keep sane ceilings).
time_limit: 2
rlimit_cpu: 2
rlimit_fsize: 65536
rlimit_nofile: 64
rlimit_nproc: 64
rlimit_core: 0

log_level: WARNING
log_fd: -1


